I decided to update to debian 8. All of the instructions are laid out here:

https://www.debian.org/releases/jessie/amd64/release-notes/ch-upgrading.en.html

So let's get to it.

### Backups

From the above page:


> The main things you'll want to back up are the contents of /etc, /var/lib/dpkg, /var/lib/apt/extended_states and the output of dpkg --get-selections "*" (the quotes are important). 

elatov@kerch:~$ dpkg --get-selections "*" > /tmp/dpkg-jessie.txt
elatov@kerch:~$ sudo tar cpvjf deb-jess.tar.bz2 /etc /var/lib/dpkg /var/lib/apt/extended_states /tmp/dpkg-jessie.txt
elatov@kerch:~$ls -lh deb-jess.tar.bz2 
-rw-r--r-- 1 root root 5.1M Jun 19 09:00 deb-jess.tar.bz2

### Check the status of Packages

I was doing my upgrade remotely so I went ahead and started a screen session at this point. Then checking to make sure all the packages are okay:

elatov@kerch:~$sudo  dpkg --audit
elatov@kerch:~$

I also checked I didn't have any packages on hold:

elatov@kerch:~$aptitude search "~ahold" 
elatov@kerch:~$dpkg --get-selections | grep 'hold$'

### Modify /etc/apt/source.lists

Prior to the update here is how my file looked like:

elatov@kerch:~$cat /etc/apt/sources.list
#

# deb cdrom:[Debian GNU/Linux 7.2.0 _Wheezy_ - Official amd64 NETINST Binary-1 20131012-14:04]/ wheezy main

#deb cdrom:[Debian GNU/Linux 7.2.0 _Wheezy_ - Official amd64 NETINST Binary-1 20131012-14:04]/ wheezy main

deb http://ftp.us.debian.org/debian/ wheezy main
deb-src http://ftp.us.debian.org/debian/ wheezy main

deb http://security.debian.org/ wheezy/updates main
deb-src http://security.debian.org/ wheezy/updates main

# wheezy-updates, previously known as 'volatile'
deb http://ftp.us.debian.org/debian/ wheezy-updates main
deb-src http://ftp.us.debian.org/debian/ wheezy-updates main

# wheezy backports
deb http://ftp.debian.org/debian wheezy-backports main contrib non-free

# non-free ports
deb http://ftp.fr.debian.org/debian/ wheezy main contrib non-free

I just ended up using sed to replace wheezy with jessie:

elatov@kerch:~$sudo sed -i "s/wheezy/jessie/" /etc/apt/sources.list

I also had alienvault and puppetlabs sources:

elatov@kerch:~$ls -l /etc/apt/sources.list.d
total 12
-rw-r--r-- 1 root root 100 Nov  1  2014 alienvault.list
-rw-r--r-- 1 root root 385 Aug 25  2014 puppetlabs.list

They just had one lines:

elatov@kerch:~$cat /etc/apt/sources.list.d/*.list
#file generated by puppet
# alienvault
deb http://ossec.alienvault.com/repos/apt/debian wheezy main
# Puppetlabs products
deb http://apt.puppetlabs.com precise main
deb-src http://apt.puppetlabs.com precise main

# Puppetlabs dependencies
deb http://apt.puppetlabs.com precise dependencies
deb-src http://apt.puppetlabs.com precise dependencies

# Puppetlabs devel (uncomment to activate)
# deb http://apt.puppetlabs.com precise devel
# deb-src http://apt.puppetlabs.com precise devel

So I ran the following to update them to jessie:

elatov@kerch:~$sudo sed -i "s/wheezy/jessie/" /etc/apt/sources.list.d/alienvault.list
elatov@kerch:~$sudo sed -i "s/precise/jessie/" /etc/apt/sources.list.d/puppetlabs.list

I also have zabbix installed on that system, but reading over this zabbix forum:

https://www.zabbix.com/forum/showthread.php?t=49349

It looks like there is no zabbix jessie repo yet. Hopefully it will come out soon.

I disabled the zabbix repo for now and the jessie repos actually have a 2.2 version:

elatov@kerch:~$apt-cache showpkg zabbix-server-mysql
Package: zabbix-server-mysql
Versions:
1:2.2.9-1+wheezy (/var/lib/dpkg/status)
 Description Language:
                 File: /var/lib/apt/lists/ftp.us.debian.org_debian_dists_jessie_main_binary-amd64_Packages
                  MD5: 47873543449b5d6688721f179370dff6
 Description Language: en
                 File: /var/lib/apt/lists/ftp.us.debian.org_debian_dists_jessie_main_i18n_Translation-en
                  MD5: 47873543449b5d6688721f179370dff6

1:2.2.7+dfsg-2 (/var/lib/apt/lists/ftp.us.debian.org_debian_dists_jessie_main_binary-amd64_Packages) (/var/lib/
apt/lists/ftp.fr.debian.org_debian_dists_jessie_main_binary-amd64_Packages)
 Description Language:
                 File: /var/lib/apt/lists/ftp.us.debian.org_debian_dists_jessie_main_binary-amd64_Packages
                  MD5: 47873543449b5d6688721f179370dff6
 Description Language: en
                 File: /var/lib/apt/lists/ftp.us.debian.org_debian_dists_jessie_main_i18n_Translation-en
                  MD5: 47873543449b5d6688721f179370dff6


Reverse Depends:
  zabbix-server-pgsql,zabbix-server-mysql
  zabbix-proxy-sqlite3,zabbix-server-mysql
  zabbix-proxy-pgsql,zabbix-server-mysql
  zabbix-proxy-mysql,zabbix-server-mysql

And I was on 2.2 so hopefully that will be okay :)

### Upgrading the packages

To be extra safe we can also use script to record the session so we can review what we did later on. To do that just run the following:

elatov@kerch:~$script -t 2>~/upgrade-jessie_1.time -a ~/upgrade-jessie_1.script
Script started, file is /home/elatov/upgrade-jessie_1.script

Now let's update the package list:

sudo apt-get update

And now let's upgrade the packages:

elatov@kerch:~$sudo apt-get upgrade
Reading package lists... Done  
Building dependency tree
Reading state information... Done
The following packages have been kept back:
  acpid anacron apache2 apache2-mpm-prefork apache2-utils apache2.2-bin apache2.2-common apt apt-utils
  aptitude aptitude-common base-passwd bind9-host bsdutils build-essential bzip2 cmake cmake-data cpp cron
  curl dbus default-jre default-jre-headless dmsetup dnsutils dpkg dstat elinks elinks-data exim4 exim4-base
  exim4-config exim4-daemon-light expect fakeroot flex fontconfig fontconfig-config fping g++ gcc ghostscript
  gir1.2-freedesktop gir1.2-gdkpixbuf-2.0 gir1.2-glib-2.0 gir1.2-rsvg-2.0 imagemagick initramfs-tools
  initscripts iproute iptables iptables-persistent iputils-ping isc-dhcp-client isc-dhcp-common krb5-multidev
  libalgorithm-diff-xs-perl libapache2-mod-php5 libapache2-mod-proxy-html libapr1 libapr1-dev libaprutil1
  libaprutil1-dbd-sqlite3 libaprutil1-dev libaprutil1-ldap libapt-pkg-perl libapt-pkg4.12 libasound2
  libatk-wrapper-java-jni libatk1.0-0 libatk1.0-data libaugeas-ruby libaugeas-ruby1.9.1
  libboost-filesystem-dev libboost-program-options-dev libboost-test-dev libbz2-1.0 libbz2-dev
  libcairo-gobject2 libcairo-script-interpreter2 libcairo2 libcairo2-dev libcrypt-ssleay-perl libcups2
  libcupsimage2 libcurl3 libcurl3-gnutls libcurl4-openssl-dev libcwidget3 libdbd-mysql-perl libdbi-perl
  libdevmapper-event1.02.1 libdevmapper1.02.1 libdjvulibre-dev libdjvulibre21 libdumbnet-dev libdumbnet1
  libept1.4.12 libfile-fcntllock-perl libfontconfig1 libfontconfig1-dev libgcc1 libgcrypt11-dev
  libgdk-pixbuf2.0-0 libgdk-pixbuf2.0-common libgdk-pixbuf2.0-dev libgirepository-1.0-1 libgl1-mesa-dev
  libgl1-mesa-dri libgl1-mesa-glx libglapi-mesa libglib2.0-0 libglib2.0-bin libglib2.0-dev
  libgnutls-openssl27 libgomp1 libgraphviz-dev libgs9 libgs9-common libgssapi-krb5-2 libgssrpc4
  libgstreamer-plugins-base0.10-0 libgstreamer0.10-0 libgtk2.0-0 libgtk2.0-bin libhtml-parser-perl
  libhttp-message-perl libiksemel3 libio-socket-ssl-perl libitm1 libjasper-dev libjasper1 libjson0
  libjson0-dev libk5crypto3 libkrb5-3 libkrb5-dev libkrb5support0 libldap-2.4-2 libldap2-dev
  liblist-moreutils-perl liblocale-gettext-perl libmagickcore-dev libmagickwand-dev libmailtools-perl libmng1
  libnet-ssleay-perl libnetpbm10 libopenexr-dev libopenexr6 libp11-kit-dev libp11-kit0 libpam-modules
  libpam-modules-bin libpam0g libpango1.0-0 libpaper1 libpathplan4 libpulse0 libqt4-dbus libqt4-declarative
  libqt4-designer libqt4-dev libqt4-dev-bin libqt4-help libqt4-network libqt4-opengl libqt4-opengl-dev
  libqt4-qt3support libqt4-script libqt4-scripttools libqt4-sql libqt4-sql-mysql libqt4-svg libqt4-test
  libqt4-xml libqt4-xmlpatterns libqtcore4 libqtdbus4 libqtgui4 libqtwebkit-dev libqtwebkit4 libquadmath0
  librsvg2-2 librsvg2-common librsvg2-dev librtmp-dev libsasl2-2 libsemanage-common libsemanage1 libsnmp-base
  libsnmp-perl libsocket-perl libssh2-1 libssh2-1-dev libstdc++6 libtext-charwidth-perl libtext-iconv-perl
  libuuid-perl libwmf-dev libwmf0.2-7 libxapian22 libxdot4 libxft2 libxslt1-dev libxslt1.1
  linux-headers-amd64 linux-image-amd64 login lvm2 m4 mesa-common-dev mount mysql-client-5.5 mysql-server-5.5
  netpbm open-vm-tools openipmi openssh-client openssh-server passwd perl perl-base perl-modules php5
  php5-cli php5-common php5-gd php5-mysql procps python python-apt python-minimal python2.7 python2.7-minimal
  qdbus qt4-linguist-tools qt4-qmake rsyslog ruby ruby-dev ruby-json ruby-shadow shared-mime-info snmp snmpd
  sudo sysv-rc sysvinit sysvinit-utils task-ssh-server tasksel-data tcl8.5 ttf-dejavu-core ttf-dejavu-extra
  udev ufraw-batch util-linux util-linux-locales wget wkhtmltopdf xvfb
The following packages will be upgraded:
  acpi acpi-support-base apt-file augeas-lenses augeas-tools autotools-dev base-files bash bash-completion
  binutils binutils-dev bison bsdmainutils busybox ca-certificates ca-certificates-java chkconfig comerr-dev
  console-setup console-setup-linux coreutils cpio csh dash dbconfig-common debconf debconf-i18n
  debconf-utils debian-archive-keyring debianutils di dictionaries-common diffutils discover discover-data
  dkms dmidecode dpkg-dev e2fslibs e2fsprogs eject emacsen-common ethtool file findutils fonts-droid
  geoip-database gettext-base git git-core git-man gnupg gpgv grep groff-base grub-common grub-pc grub-pc-bin
  grub2-common gzip hdparm heirloom-mailx hicolor-icon-theme hostname htop icedtea-netx icedtea-netx-common
  ifupdown imagemagick-common info install-info installation-report ipmitool iso-codes java-common
  java-wrappers javascript-common kbd keyboard-configuration klibc-utils kmod krb5-locales less libacl1
  libaio1 libalgorithm-diff-perl libapt-inst1.5 libasprintf0c2 libasyncns0 libatk-wrapper-java libattr1
  libaudio2 libaugeas0 libavahi-client3 libavahi-common-data libavahi-common3 libbison-dev libblkid1 libbsd0
  libcap2 libclass-isa-perl libcomerr2 libconfig-inifiles-perl libcroco3 libdatrie1 libdbus-1-3 libdiscover2
  libdjvulibre-text libdnet libdnet-dev libdpkg-perl libdrm-intel1 libdrm-radeon1 libdrm2 libedit2 libelf1
  liberror-perl libexif-dev libexif12 libexpat1 libexpat1-dev libflac8 libfontenc1 libfreetype6
  libfreetype6-dev libfuse2 libgdbm3 libgeoip1 libgif4 libglib2.0-data libglu1-mesa libglu1-mesa-dev libgmp10
  libgpg-error-dev libgpg-error0 libgpm2 libgtk2.0-common libhtml-format-perl libhtml-template-perl
  libhtml-tree-perl libhttp-cookies-perl libice-dev libice6 libidn11 libidn11-dev libijs-0.35 libilmbase-dev
  libilmbase6 libio-socket-ip-perl libjargs-java libjbig-dev libjbig0 libjs-jquery libkeyutils1 libklibc
  libkmod2 liblcms2-2 liblensfun-data liblensfun0 liblockfile-bin liblockfile1 liblqr-1-0 liblqr-1-0-dev
  libltdl-dev libltdl7 liblwp-protocol-https-perl liblzma5 libmagic1 libmount1 libmpfr4 libmysql++-dev
  libmysql++3 libmysqlclient-dev libmysqlclient18 libncurses5 libncursesw5 libnet-http-perl libnettle4
  libnewt0.52 libnfnetlink0 libnspr4 libnss3 libodbc1 libogg0 libonig2 libopenipmi0 liborc-0.4-0
  libpam-runtime libpaper-utils libpcap0.8 libpcap0.8-dev libpci3 libpciaccess0 libpcre3 libpcre3-dev
  libpcrecpp0 libpcsclite1 libpipeline1 libpixman-1-0 libpixman-1-dev libpng12-0 libpng12-dev libpopt0
  libpq-dev libpq5 libpthread-stubs0-dev libqdbm14 libreadline-gplv2-dev libreadline5 libreadline6
  libregexp-assemble-perl libsasl2-modules libselinux1 libsensors4 libsepol1 libsgutils2-2 libsigc++-2.0-0c2a
  libslang2 libsm-dev libsm6 libsndfile1 libsqlite3-0 libsqlite3-dev libss2 libssl-dev libssl-doc libssl1.0.0
  libswitch-perl libsystemd-login0 libthai-data libthai0 libtimedate-perl libtinfo-dev libtinfo5 libtool
  libtre5 liburi-perl libusb-0.1-4 libustr-1.0-1 libuuid1 libvorbis0a libvorbisenc2 libwrap0 libwww-perl
  libx11-6 libx11-data libx11-dev libx11-doc libx11-xcb1 libxau-dev libxau6 libxaw7 libxcb-glx0
  libxcb-render0 libxcb-render0-dev libxcb-shm0 libxcb-shm0-dev libxcb1 libxcb1-dev libxcomposite1
  libxcursor1 libxdamage1 libxdmcp-dev libxdmcp6 libxext-dev libxext6 libxfixes3 libxfont1 libxi6
  libxinerama1 libxml2 libxml2-dev libxmlrpc-core-c3 libxmu6 libxmuu1 libxpm4 libxrandr2 libxrender-dev
  libxrender1 libxt-dev libxt6 libxtst6 libxxf86vm1 libyajl-dev libyajl2 libyaml-0-2 libyaml-dev
  linux-libc-dev lsb-base lsb-release lsscsi make man-db manpages manpages-dev mime-support mlocate
  module-init-tools multiarch-support mysql-client mysql-common mysql-server mysql-server-core-5.5 nano
  ncurses-base ncurses-bin ncurses-term net-tools netbase netcat-traditional ntpdate openssl os-prober patch
  pciutils pkg-config poppler-data powermgmt-base psmisc python-apt-common readline-common rsync screen sed
  sensible-utils sg3-utils smistrip snmptt ssl-cert strace sysstat tar tcpd tcpdump traceroute tree tzdata
  tzdata-java ucf unzip uuid-dev vim vim-common vim-runtime vim-tiny virt-what whiptail whois x11-common
  x11-xkb-utils x11proto-core-dev x11proto-input-dev x11proto-xext-dev xauth xfonts-encodings xfonts-utils
  xkb-data xorg-sgml-doctools xserver-common xtrans-dev xz-utils yui-compressor zerofree zlib1g zlib1g-dev
365 upgraded, 0 newly installed, 0 to remove and 263 not upgraded.
Need to get 116 MB of archives.
After this operation, 47.7 MB of additional disk space will be used.
Do you want to continue [Y/n]?

### Upgrade the System

Now we are ready to perform the important step. First let's make sure we have enough space, we can run the following to confirm:

elatov@kerch:~$df -Ph
Filesystem              Size  Used Avail Use% Mounted on
/dev/mapper/kerch-root   15G  8.3G  5.8G  59% /
udev                     10M     0   10M   0% /dev
tmpfs                   202M  216K  202M   1% /run
tmpfs                   5.0M     0  5.0M   0% /run/lock
tmpfs                   403M     0  403M   0% /run/shm
/dev/sda1               228M   26M  191M  12% /boot

elatov@kerch:~$sudo apt-get -o APT::Get::Trivial-Only=true dist-upgrade
..
..
257 upgraded, 289 newly installed, 14 to remove and 5 not upgraded.
Need to get 352 MB of archives.
After this operation, 580 MB of additional disk space will be used.
E: Trivial Only specified but this is not a trivial operation.

Initially it looks like it wanted to remove the zabbix-server:

elatov@kerch:~$sudo apt-get -o APT::Get::Trivial-Only=true dist-upgrade
Reading package lists... Done
Building dependency tree
Reading state information... Done
Calculating upgrade... Done
The following packages will be REMOVED:
  apache2-prefork-dev cpp-4.7 g++-4.7 gcc-4.7 gcc-4.7-base libaudit0 libgnutls-dev libgvc5 libkadm5srv-mit8
  libperl5.14 librtmp-dev libsnmp15 libstdc++6-4.7-dev zabbix-server-mysql


If we are good let's do the system upgrade:

elatov@kerch:~$sudo apt-get dist-upgrade

after that's done clean up old packages

sudo apt-get autoremove

### Config clean up

Before rebooting we can clean delete packages that have left over configs. To list those run the following:

dpkg -l | awk '/^rc/ { print $2 }'


Mine listed the zabbix-server, so I just saved the output to a file:

elatov@kerch:~$dpkg -l | awk '/^rc/ { print $2 }' > remove

Then I modified the file and removed any packages I wanted to keep and then ran the following to clean up packages I wanted to clean up:

elatov@kerch:~$sudo apt-get purge $(cat remove)

### Post Upgrade

I then reinstalled the zabbix-server-mysql package

sudo apt-get install zabbix-server-mysql

I also used the iptables-persistent package to load iptables rules, but it looks like that has changed:

https://packages.debian.org/jessie/admin/iptables-persistent

So now I can just use the netfilter-persistent package and just keep my files under /etc/iptables/rules.v4. So I just enabled that via systemd

But that failed with the following:

Jun 19 13:57:56 kerch systemd-modules-load[19081]: Failed to insert 'ipmi_si': No such device
Jun 19 13:57:56 kerch kernel: ipmi_si: Unable to find any System Interface(s)
Jun 19 13:57:56 kerch puppet-agent[18602]: Could not start Service[netfilter-persistent]: Execution of '/bin/systemctl start
Jun 19 13:57:56 kerch puppet-agent[18602]: (/Stage[main]/Iptables::Service/Service[netfilter-persistent]/ensure) change from
Jun 19 13:57:56 kerch systemd[1]: systemd-modules-load.service: main process exited, code=exited, status=1/FAILURE
Jun 19 13:57:56 kerch systemd[1]: Failed to start Load Kernel Modules.
Jun 19 13:57:56 kerch systemd[1]: Dependency failed for netfilter persistent configuration.


I noticed that ipmitool was loading some old modules, so after removing the ipmitools package:

sudo apt-get purge ipmitools

I was able to start the netfilter-persistent without issues:

elatov@kerch:~$sudo systemctl status netfilter-persistent.service 
● netfilter-persistent.service - netfilter persistent configuration
   Loaded: loaded (/lib/systemd/system/netfilter-persistent.service; enabled)
   Active: active (exited) since Fri 2015-06-19 14:09:09 MDT; 3s ago
  Process: 20461 ExecStart=/usr/sbin/netfilter-persistent start (code=exited, status=0/SUCCESS)
 Main PID: 20461 (code=exited, status=0/SUCCESS)

Jun 19 14:09:09 kerch netfilter-persistent[20461]: run-parts: executing /usr/share/netfilter-persistent/plugins.d/15...start
Jun 19 14:09:09 kerch netfilter-persistent[20461]: run-parts: executing /usr/share/netfilter-persistent/plugins.d/25...start
Jun 19 14:09:09 kerch netfilter-persistent[20461]: Warning: skipping IPv6 (no rules to load)
Hint: Some lines were ellipsized, use -l to show in full.

Also instead of compiling passenger installed and enabled it for apache
sudo apt-get install libapache2-mod-passenger
sudo a2enmod passenger

