Update kerch zabbix from 2.2 to 2.4

sudo systemctl stop zabbix-agent.service
sudo systemctl stop zabbix-server.service

Then modify the apt source

┌─[elatov@kerch] - [/etc/apt/sources.list.d] - [2015-11-29 10:09:00]
└─[0] <> cat /etc/apt/sources.list.d/zabbix.list
#file generated by puppet
# zabbix
#deb http://repo.zabbix.com/zabbix/2.2/debian/ wheezy main
#deb-src http://repo.zabbix.com/zabbix/2.2/debian/ wheezy main
deb http://repo.zabbix.com/zabbix/2.4/debian/ jessie main
deb-src http://repo.zabbix.com/zabbix/2.4/debian/ jessie main

Then update the cache to make sure it's okay

sudo apt-get update

Then do the update

sudo apt-get upgrade

# if asked to replace the configuration files I ended up keeping my own cause
they were so close.

One thing to add:

Modify the apache conf

 <IfModule mod_php5.c>
+        php_value max_execution_time 300
+        php_value memory_limit 128M
+        php_value post_max_size 16M
+        php_value upload_max_filesize 2M
+        php_value max_input_time 300
+        # php_value date.timezone Europe/Riga
+    </IfModule>

to add to server config

+### Option: VMwarePerfFrequency
 │ +# How often Zabbix will connect to VMware service to obtain performance
 │ data.
 │ +#
 │ +# Mandatory: no
 │ +# Range: 10-86400
 │ +# Default:
 │ +# VMwarePerfFrequency=60
 │ +

+### Option: VMwareTimeout
 │ +# Specifies how many seconds vmware collector waits for response from
 │ VMware service.
 │ +#
 │ +# Mandatory: no
 │ +# Range: 1-300
 │ +# Default:
 │ +# VMwareTimeout=10

Then had to delete all the ESXi host and VMs and re-add the host
To use VMware simple checks the host must have the following user macros defined:

{$URL} - VMware service (vCenter or ESX hypervisor) SDK URL (https://servername/sdk).
{$USERNAME} - VMware service user name
{$PASSWORD} - VMware service {$USERNAME} user password

Then waited for the discovery of all the VMs and it worked out. After that
just added the zabbix agent directly, so there are two different entry for the
same VM, but that's ok for further updates

# then modified the templates to use the new last function

Name: HV Memory Usage Percentage
Formula:
("vmware.hv.memory.used[{$URL},{HOST.HOST}]".last())/("vmware.hv.hw.memory[{$URL},{HOST.HOST}]".last())

Name: HV CPU Usage Percentage
Formula: 
last("vmware.hv.cpu.usage[{$URL},{HOST.HOST}]")/(last("vmware.hv.hw.cpu.freq[{$URL},{HOST.HOST}]")*last("vmware.hv.hw.cpu.threads[{$URL},{HOST.HOST}]"))

Name: Total CPU Available
Formula: last("vmware.hv.hw.cpu.freq[{$URL},{HOST.HOST}]")*last("vmware.hv.hw.cpu.threads[{$URL},{HOST.HOST}]")

# also re-added the sd-temp monitor
New Item for host:

Name: SSD_Temp
Type: SSH_Agent
Key: ssh.run[ssd-temp,192.168.1.109,22,utf8]
Executed script: esxcli storage core device smart get -d t10.ATA_____APPLE_SSD_SM256E________________________S1AANYNF302924______ | grep 'Drive Temperature' | awk '{print $3}'
Update interval: 900

New Trigger on Host

Name: High SSD Temp on {HOST.NAME}
Expression: {f955078b-4ff2-5855-9836-0c741a9e82c3:ssh.run[ssd-temp,192.168.1.109,22,utf8].last()}>70
Severity: Warning

## While I was at it, also enable sending emails about unsupported items

Go to Configuration→Actions and select Internal as the event source. Click on Create action on the upper right to open an action configuration form.

Name: Unsupported Item
Default Subject: Item is not supported
Default message: Item "{ITEM.NAME}" on {HOST.NAME} has changed its state to 'not supported'

Problem event ID: {EVENT.ID}

{ESC.HISTORY}

Recovery Message: Check
Recovery subject: OK, Item is Supported Again
Recovery Message: Item "{ITEM.NAME}" on {HOST.NAME} became supported again

Recovery event ID: {EVENT.RECOVERY.ID}

In the Conditions tab select Event type in the New condition block and select Item in “not supported” state as the value.

Event type = item not support
event type = trigger not supported

In the Operations tab, click on New and select some recipients of the message (user groups/users) and the media types (or 'All') to use for delivery.

Step From: 1
Step To: 1
Operation type: Send Message
Send to Users: admin
Send Only to: Email

# Add email for Admin
Profile -> Media -> Add Email

# Add SMTP Server
Administration -> Media Types -> Email
SMTP Server: kerch.dnsd.me
SMTP Helo: dnsd.me
SMTP Email: zabbix@dnsd.me

### sql query to find out non supported items
SELECT * FROM zabbix.items WHERE state=1;
####
